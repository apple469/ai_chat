<!DOCTYPE html>
<!-- Declare the document type as HTML5 to ensure the browser renders the page in standards mode -->
<html>
<head>
    <!-- Set the character encoding to UTF-8 to support multiple languages -->
    <meta charset="UTF-8">
    <!-- Set the viewport to ensure proper scaling and display on mobile devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Page title displayed on the browser tab -->
    <title>Index</title>
    <style>
    </style>
</head>
<body>
    <h4>Please enter your API request URL</h4>
    <input type="text" id="apiUrl" placeholder="Enter API URL">
    <h4>Please enter your API key</h4>
    <input type="text" id="apiKey" placeholder="Enter API key">
    <h4>Please enter the target model</h4>
    <input type="text" id="model" placeholder="Enter target model">
    <button onclick="saveConfig()">Save Configuration</button>
    <p id="status"></p>


    <h4>Please select a model</h4>
    <label for="model_name">Model Name:</label>
    <select id="model_name">
        <option value="">please select</option>
    </select>
    <button onclick="add_model()">Refresh</button>

    <input type="text" id="userInput" placeholder="Enter your question">
    <button onclick="sendRequest()">Send Request</button>
    <p id="response"></p>


    <script>
        async function saveConfig() {
            const status = document.getElementById('status');
            const apiUrl = document.getElementById('apiUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('model').value;

            if (!apiKey || !model) {
                status.textContent = 'Please complete the configuration';
                return;
            }

            try {
                const response = await fetch('/admin/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: "add",
                        provider: 'gemini',
                        apiurl: apiUrl,
                        apikey: apiKey,
                        model_name: model,
                        name: model
                    })
                });
                if (!response.ok) {
                    status.textContent = 'Failed to save configuration, ' + response.statusText;
                    return;
                }
            } catch (error) {
                status.textContent = 'Failed to save configuration, ' + error.message;
                return;
            }

            status.textContent = 'Configuration saved';
        }
        async function add_model() {
            const model_name_select = document.getElementById('model_name');
            // 清除除了第一个“请选择”选项之外的所有现有选项
            while (model_name_select.children.length > 1) {
                model_name_select.removeChild(model_name_select.lastChild);
            }

            try {
                const response = await fetch('/admin/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: "query"
                    })
                });
                if (!response.ok) {
                    model_config.textContent = 'Failed to query configuration, ' + response.statusText;
                    return;
                }
                const data = await response.json();
                if (data.success && data.data && Array.isArray(data.data)) {
                    data.data.forEach(config => {
                        const option = document.createElement('option');
                        option.value = config.name;
                        option.textContent = config.name;
                        model_name_select.appendChild(option);
                    });
                }
                // Find the configuration item matching the user input model_name
                let foundApiUrl = 'No configuration found for the specified model';
                if (data.success && data.data && Array.isArray(data.data)) {
                    const matchedConfig = data.data.find(config => config.model_name === model_name_select.value);
                    if (matchedConfig && matchedConfig.apiurl) {
                        foundApiUrl = matchedConfig.apiurl;
                    }
                }
            } catch (error) {
                model_config.textContent = 'Failed to query configuration, ' + error.message;
                return;
            }
        }
        async function sendRequest() {
            const userInput = document.getElementById('userInput').value;
            const response = document.getElementById('response');
            if (!userInput) {
                response.textContent = 'Please complete your question';
                return;
            }
            response.textContent = 'Determining request...';
            try {
                router_response = await fetch('/router', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: userInput
                    })
                });
                if (!router_response.ok) {
                    response.textContent = 'Routing failed';
                    return;
                }
                const router_data = await router_response.json();
                response.textContent = 'Request classified as: ' + router_data.label;
                let thinking_budget = 0;
                if (router_data.label === 'thinking') {
                    thinking_budget = 800;
                } else {
                    thinking_budget = 0;
                }

                const ai_response = await fetch('/ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: document.getElementById('model_name').value,
                        thinking_budget: thinking_budget,
                        query: userInput
                    })
                });
                if (!ai_response.ok) {
                    response.textContent = 'API request failed';
                    return;
                }
                const ai_data = await ai_response.json();
                response.textContent = '<think>' + ai_data.think_text + '</think>' + ai_data.text;
            } catch (error) {
                console.error('Error:', error);
                response.textContent = "Request failed, please try again later.";
            }
        }
    </script>
</body>
</html>