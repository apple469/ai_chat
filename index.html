<!DOCTYPE html>
<!-- 声明文档类型为HTML5，确保浏览器以标准模式渲染页面 -->
<html>
<head>
    <!-- 设置字符编码为UTF-8，支持中文及多语言字符 -->
    <meta charset="UTF-8">
    <!-- 设置视口，确保在移动设备上正确缩放和显示 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 页面标题，显示在浏览器标签页上 -->
    <title>index</title>
    <style>
    </style>
</head>
<body>
    <h4>请输入你的api请求地址</h4>
    <input type="text" id="apiUrl" placeholder="请输入api地址">
    <h4>请输入你的api_key</h4>
    <input type="text" id="apiKey" placeholder="请输入api_key">
    <h4>请输入目标请求模型</h4>
    <input type="text" id="model" placeholder="请输入目标模型">
    <button onclick="saveConfig()">保存配置</button>
    <p id="status"></p>


    <h4>请输入模型名称以查询配置</h4>
    <input type="text" id="model_name" placeholder="请输入模型名称">
    <button onclick="queryConfig()">查询</button>
    <p id="model_config"></p>

    <input type="text" id="userInput" placeholder="请输入你的问题">
    <button onclick="sendRequest()">发送请求</button>
    <p id="response"></p>


    <script>
        async function saveConfig() {
            const status = document.getElementById('status');
            const apiUrl = document.getElementById('apiUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('model').value;

            if (!apiKey || !model) {
                status.textContent = '请填写完整配置';
                return;
            }

            try {
                const response = await fetch('/admin/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: "add",
                        provider: 'gemini',
                        apiurl: apiUrl,
                        apikey: apiKey,
                        model_name: model,
                        name: model
                    })
                });
                if (!response.ok) {
                    status.textContent = '保存配置失败,' + response.statusText;
                    return;
                }
            } catch (error) {
                status.textContent = '保存配置失败,' + error.message;
                return;
            }

            status.textContent = '配置已保存';
        }
        async function queryConfig() {
            const model_name = document.getElementById('model_name').value;
            const model_config = document.getElementById('model_config');
            if (!model_name) {
                model_config.textContent = '请填写模型名称';
                return;
            }
            try {
                const response = await fetch('/admin/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: "query"
                    })
                });
                if (!response.ok) {
                    model_config.textContent = '查询配置失败,' + response.statusText;
                    return;
                }
                const data = await response.json();
                // 查找与用户输入的model_name相匹配的配置项
                let foundApiUrl = '未找到对应模型的配置';
                if (data.success && data.data && Array.isArray(data.data)) {
                    const matchedConfig = data.data.find(config => config.model_name === model_name);
                    if (matchedConfig && matchedConfig.apiurl) {
                        foundApiUrl = matchedConfig.apiurl;
                    }
                }
                model_config.textContent = '查询配置成功,' + JSON.stringify(data) + ',已选择模型' + model_name + '(模型对应url:' + foundApiUrl + ')';
            } catch (error) {
                model_config.textContent = '查询配置失败,' + error.message;
                return;
            }
        }
        async function sendRequest() {
            const userInput = document.getElementById('userInput').value;
            const response = document.getElementById('response');
            if (!userInput) {
                response.textContent = '请填写完整问题';
                return;
            }
            response.textContent = '正在判断请求...';
            try {
                router_response = await fetch('/router', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: userInput
                    })
                });
                if (!router_response.ok) {
                    response.textContent = '路由判断失败';
                    return;
                }
                const router_data = await router_response.json();
                response.textContent = '请求分类为：' + router_data.label;
                let thinking_budget = 0;
                if (router_data.label === 'thinking') {
                    thinking_budget = 800;
                } else {
                    thinking_budget = 0;
                }

                const ai_response = await fetch('/ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: document.getElementById('model_name').value,
                        thinking_budget: thinking_budget,
                        query: userInput
                    })
                });
                if (!ai_response.ok) {
                    response.textContent = 'api请求失败';
                    return;
                }
                const ai_data = await ai_response.json();
                response.textContent = '<think>' + ai_data.think_text + '</think>' + ai_data.text;
            } catch (error) {
                console.error('Error:', error);
                response.textContent = "请求失败，请稍后再试。";
            }
        }
    </script>
</body>
</html>